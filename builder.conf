###############################################################################
# To enable this flavor, add it to the builder.conf `BUILDER_PLUGINS`:
#   BUILDER_PLUGINS += app-salt-config
#
# There are 3 options to be able to apply this flavor to VM's
#
# 1) Use the `setup` program and select desired configurations when prompted
#
# 2) Add the `+salt` flavor to selected VM's like follows:
#    DISTS_VM += fc21+salt
#
# 3) Add the flavor globally to any template being built, by adding the
#    DIST match patterns to the main builder.conf.
#    TEMPLATE_FLAVOR_SALT = wheezy+minimal +standard whonix fc21
###############################################################################

# Uncomment to enable the `+app-salt-config` template flavor
# BUILDER_PLUGINS += app-salt-config

# TEMPLATE_FLAVOR_SALT - String separated list of whole or partial DIST_VMs
# and or flavors used to match which DIST_VMs will have flavor applied
#
# Example: 
#   TEMPLATE_FLAVOR_SALT = wheezy+minimal +standard whonix fc21
# Default:
#   no value

################################################################################
#                           S E L F   N A M E
################################################################################
_self := $(strip $(lastword 1,$(subst /, ,$(dir $(lastword $(MAKEFILE_LIST))))))

_flavor_name = +salt

_supported_vms ?= fc20 fc21 fc22 
_supported_vms += wheezy jessie
_supported_vms += trusty utopic vivid
_supported_vms += whonix-gateway whonix-workstation

# -----------------------------------------------------------------------------
# Called by setup since GET_VAR is defined, so enable all DISTS_VMS
# Add flavor to all supported DISTS_VMs
# -----------------------------------------------------------------------------
ifdef GET_VAR
    _filter = $(if $(findstring $(_flavor_name), $(_dist_vm)),,$(word 1,$(subst +, ,$(_dist_vm))))
    _dist = $(_dist_vm) $(_dist_vm)$(_flavor_name)
    _vm = $(if $(filter $(_filter), $(_supported_vms)), $(_dist))
    _template_flavor_salt := $(sort $(foreach _dist_vm, $(DISTS_VM), $(_vm)))

else ifdef TEMPLATE_FLAVOR_SALT
    _dist_flavor = $(_dist_vm)$(_flavor_name)

    _set_label = $(eval _label = $(filter $(_label_name):%, $(TEMPLATE_LABEL))) \
		 $(eval _label_left = $(word 1,$(subst :, ,$(_label)))) \
		 $(eval _label_right = $(word 2,$(subst :, ,$(_label)))) \
                 $(if $(_label_right), \
		 $(eval TEMPLATE_LABEL += $(_dist_flavor):$(_label_right)$(subst +,-,$(_flavor_name))) \
                 ) 

    _set_alias = $(eval _alias = $(filter %:$(_dist_vm), $(TEMPLATE_ALIAS))) \
		 $(eval _alias_left = $(word 1,$(subst :, ,$(_alias)))) \
		 $(eval _label_name = $(or $(word 2,$(subst :, ,$(_alias)))), $(_dist_vm)) \
                 $(if $(_alias_left), \
    	 	     $(eval TEMPLATE_ALIAS += $(_alias_left):$(_dist_flavor)) \
                 ) \
	         $(_set_label) \
                 $(eval TEMPLATE_ALIAS := $(filter-out $(_alias), $(TEMPLATE_ALIAS))) 

    _add_flavor = $(_set_alias) $(_dist_flavor)
    _filter = $(if $(findstring $(_flavor_name), $(_dist_vm)), $(_dist_vm), $(_add_flavor))
    _patsubst = $(eval DISTS_VM = $(patsubst $(_dist_vm), $(_filter), $(DISTS_VM)))
    _dist = $(if $(findstring $(_flavor), $(_dist_vm)), $(_patsubst),)

    _foreach_flavor = $(foreach _flavor, $(TEMPLATE_FLAVOR_SALT), $(_dist))
    _foreach_distvm = $(foreach _dist_vm, $(DISTS_VM), $(_foreach_flavor))
    _template_flavor_salt := $(_foreach_distvm) $(DISTS_VM)

# -----------------------------------------------------------------------------
# No flavors defined; Just use DISTS_VM as-is
# -----------------------------------------------------------------------------
else ifneq (,$(findstring $(_flavor_name), $(DISTS_VM)))
    _template_flavor_salt := $(DISTS_VM)

# -----------------------------------------------------------------------------
#  Do Not Enable
# -----------------------------------------------------------------------------
else
    _template_flavor_salt := 
endif

TEMPLATE_FLAVOR_SALT := $(_template_flavor_salt)
ifneq "$(TEMPLATE_FLAVOR_SALT)" ""

    # Define flavor directory location (here)
    TEMPLATE_FLAVOR_DIR += $(_flavor_name):$(SRC_DIR)/app-salt-config/template

    INCLUDED := 1
    -include $(SRC_DIR)/$(_self)/Makefile

    [==- 'app-salt' ============================================================
    [==-  defaults: [R2:2014.7.2, R3:2014.7.2]
    [==-
    [==- 'Insert COMPONENT/TEMPLATE after gui-agent-linux'
    [===========================================================================
    COMPONENTS := $(strip $(filter-out app-salt, $(COMPONENTS)))
    COMPONENTS := $(strip $(patsubst gui-agent-linux, gui-agent-linux app-salt, $(COMPONENTS)))
    TEMPLATE := $(strip $(patsubst gui-agent-linux, gui-agent-linux app-salt, $(TEMPLATE)))
  
    [==- 'app-salt-config' =====================================================
    [==-  defaults: [R2:develop-wip, R3:develop-wip]
    [==- 
    [==- 'Insert COMPONENT/TEMPLATE after app-salt'
    [===========================================================================
    COMPONENTS := $(strip $(filter-out app-salt-config, $(COMPONENTS)))
    COMPONENTS := $(strip $(patsubst app-salt, app-salt app-salt-config, $(COMPONENTS)))
    TEMPLATE := $(strip $(patsubst app-salt, app-salt app-salt-config, $(TEMPLATE)))
    #BRANCH_app_salt_config = develop-wip

    # Update DISTS_VM with template flavors
    DISTS_VM := $(TEMPLATE_FLAVOR_SALT)
endif

# Now that COMPONENTS have been loaded, de-register this BUILDER_PLUGIN to 
# prevent the RPM_SPEC_FILES var from this Makefile.builder from polluting
# variable scope.  Fixes an issue when building dom0 and the component 
# building does not have a -vm module to build.  What was happeneing was the
# RPM_SPEC_FILES var from this plugin was overriding the dom0 value. Specific
# example is core-libvirt failing to build since it was trying to use the
# `qubes-salt.spec` file.
#BUILDER_PLUGINS := $(filter-out app-salt-config, $(BUILDER_PLUGINS))

about::
	@echo "app-salt-config/builder.conf"

# vim: filetype=make
